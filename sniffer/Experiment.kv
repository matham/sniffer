#:kivy 1.8.1


<BoxStage>:
    name: 'box_stage'
    repeat: -1
    id: box_stage
    on_odors: self.display.next_btn.disabled = not self.odors
    on_count:
        if self.count: box_stage.barst.adc_devs[self.box].deactivate(self.__self__)
        if self.count: root.deinitialize_box()
    DigitalGateStage:
        id: box_wait
        on_started: if self.started: root.display.exp_status = 0
        name: 'box_wait'
        device: box_stage.display.next_btn if box_stage.display else None
        exit_state: True
    Delay:
        delay: root.verify.hab_dur
        on_started:
            if self.started: box_stage.barst.adc_devs[root.box].activate(root.__self__)
            if self.started: root.display.exp_status = 1
            if self.started: root.initialize_box()
    Delay:
        id: trial
        repeat: root.verify.num_trials
        Delay:
            delay: root.verify.trial_dur
            on_started:
                if self.started: root.do_odor(trial.count)
                if self.started: root.display.exp_status += 1
            on_finished: if self.finished: root.do_odor(trial.count, False)
        Delay:
            disabled: trial.count == trial.repeat - 1
            delay: root.verify.iti
            on_started: if self.started: root.display.exp_status += 1
    Delay:
        delay: root.verify.post_dur
        on_started: if self.started: root.display.exp_status += 1
        on_finished:
            if self.finished: box_stage.barst.adc_devs[root.box].deactivate(root.__self__)
            if self.finished: root.deinitialize_box()


<RootStage>:
    name: 'Root_stage'
    barst: barst
    verify: verify
    InitBarstStage:
        id: barst
        root: root
        name: 'barst'
    VerifyConfigStage:
        id: verify
        barst: barst
    MoaStage:
        id: boxes
        order: 'parallel'
